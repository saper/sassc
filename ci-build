

set -e

BUILD_DIR="${TRAVIS_BUILD_DIR:-$(pwd)/build}"

LIBSASS_SRC_DIR="${LIBSASS_SRC_DIR:-libsass}"
LIBSASS_LIB_DIR="${LIBSASS_LIB_DIR:=${BUILD_DIR}/lib}"

if [ "x$COVERAGE" == "xyes" ]; then
  COVERAGE_OPT="--enable-coverage"
  EXTRA_CFLAGS="-O0 --coverage"
  EXTRA_CXXFLAGS="-O0 --coverage"
  EXTRA_LDFLAGS="-O0 --coverage"
  export EXTRA_CFLAGS EXTRA_CXXFLAGS EXTRA_LDFLAGS
else
  COVERAGE_OPT="--disable-coverage"
fi

if [ "x$BUILD" == "xstatic" ]; then
  SHARED_OPT="--disable-shared --enable-static"
  MAKE_TARGET="static"
else
  # Makefile of sassc wants to link to static
  SHARED_OPT="--enable-shared --enable-static"
  MAKE_TARGET="shared"
fi

MAKE_OPTS="$MAKE_OPTS -j3 V=1"

if [ "x$AUTOTOOLS" == "xyes" ]; then

  echo -en 'travis_fold:start:libsass\r'
  (cd ${LIBSASS_SRC_DIR} && autoreconf --force --install &&
  ./configure --disable-tests ${COVERAGE_OPT} \
    --disable-silent-rules \
    --prefix="${BUILD_DIR}" ${SHARED_OPT} )

  # always rebuild
  (cd ${LIBSASS_SRC_DIR} && make $MAKE_OPTS clean && make $MAKE_OPTS install )
  echo -en 'travis_fold:end:libsass\r'

  echo -en 'travis_fold:start:configure\r'
  autoreconf --force --install
  ./configure ${COVERAGE_OPT} \
    --disable-silent-rules \
    --with-libsass-include="${LIBSASS_SRC_DIR}" \
    --with-libsass-lib="${LIBSASS_LIB_DIR}" \
    --prefix="${BUILD_DIR}" \
    ${SHARED_OPT}
  echo -en 'travis_fold:end:configure\r'

  # always rebuild
  make $MAKE_OPTS clean
  # does what $BUILD says
  make $MAKE_OPTS all

  mkdir -p bin
  cp -af sassc bin

else

  # always rebuild
  make $MAKE_OPTS clean

  # does what $BUILD says
  make $MAKE_OPTS all

  # sassc has static as dep
  echo make $MAKE_OPTS bin/sassc

fi

echo successfully compiled sassc
echo AUTOTOOLS=${AUTOTOOLS} COVERAGE=${COVERAGE} BUILD=${BUILD}

LD_LIBRARY_PATH="${BUILD_DIR}/lib" bin/sassc -v
